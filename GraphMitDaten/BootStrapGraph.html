<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Title</title>


    <link rel="stylesheet" type="text/css" href="Style.css" media="screen">



    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
            integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">


</head>
<body>

    <div class="container">


    </div>

    <div class=" container Boxes">

    </div>





<script>


    //Settings of the graph

    // Set the dimensions of the canvas / graph
    var margin = {top: 30, right: 50, bottom: 40, left: 50},
        width = 700 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;


    // Set the ranges
    var x = d3.scaleLinear().range([0, width]);
    var y0 = d3.scaleLinear().range([height, 0]);
    var y1 = d3.scaleLinear().range([height, 0]);

    // Define the axes


    // Define the lines
    var valueline1 = d3.line()
        .x(function (d) {
            return x(d.elapsed_time);
        })
        .y(function (d) {
            return y0(d.concentration);
        });


    var valueline2 = d3.line()
        .x(function (d) {
            return x(d.elapsed_time);
        })
        .y(function (d) {
            return y1(d.concentration);
        });


    // Adds the svg canvas
    var svg = d3.select(".container")
        .attr("id", "chart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .call(responsivefy)
        .append('g')
        .attr('transform', `translate(${margin.left}, ${margin.top})`);

    //Label X-Axis
    svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "end")
        .attr("x", width)
        .attr("y", height + 30)
        .text("Elapsed time [ms]");

    //Label Y-Axis
    svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "end")
        .attr("y", -50)
        .attr("x", -30)
        .attr("dy", ".95em")
        .attr("transform", "rotate(-90)")
        .text("Concentration [nmol/l]");


    responsivefy(svg);


    // _________________Get the data_____________________________________________________
    d3.csv("node_(0, 0)_concentrations.csv", function (error, data) {
            if (error) throw error;

            data.forEach(function (d) {
            d.species = d.species
            d.elapsed_time = +d.elapsed_time;
            d.concentration = +d.concentration;
            d.compartment = d.compartment;

        });


        // Nest the Data________________________________________________________________________________________________

        nested_data = d3.nest()
            .key(function (d) {
                return d.species;
            })
            .key(function (d) {
                return d.compartment;
            })
            .rollup(function (d) {
                d.scalemin = d3.min(d, function (d) {
                    return d.concentration
                });

                d.scalemax = d3.max(d, function (d) {
                    return d.concentration;
                });
                return d;
            })

            .entries(data);

        console.log(nested_data);
console.log(nested_data[1].values[1].value.scalemax);



        //-----------Key the data for drop down---------------------------------------------------------------------------

        var compartmentSelection = d3.nest()
            .key(function (d) {
                return d.compartment;
            })
            .rollup(function (v) {
                return v.length;
            })
            .entries(data);


        var speciesSelection = d3.nest()
            .key(function (d) {
                return d.species;
            })
            .rollup(function (v) {
                return v.length;
            })
            .entries(data);


        //---------------------------------------------------------------------------------------------------------------

        // Add Coiceboxes-------------------------------------------------------------------------------------------------


        addChoiceBox(compartmentSelection, "1_1", "Compartment");
        addChoiceBox(speciesSelection, "1_2", "Species");


        addChoiceBox(compartmentSelection, "2_1", "Compartment");
        addChoiceBox(speciesSelection, "2_2", "Species");


        selectedCompartment = $("#btn-d1_1").text();
        selectedSpecies = $("#btn-d1_2").text();

        // The Second Box-----------------------------------------------------------------


        selectedCompartment2 = $("#btn-d2_1").text();
        selectedSpecies2 = $("#btn-d2_2").text();

        //The maximum of the Dataset------------------------------------------------------------

        var scalemax = getTheRange(nested_data, selectedSpecies, selectedCompartment, selectedSpecies2, selectedCompartment2)[0];
        var scalemax2 = getTheRange(nested_data, selectedSpecies, selectedCompartment, selectedSpecies2, selectedCompartment2)[1];


        // Add the X Axis
        x.domain(d3.extent(data, function (d) {
            return d.elapsed_time;
        }));

        setXAxis(svg);

        // Define the Y Axis and the valuelines. If statement for matching datarange-------------------------------------
        if (compareRange(scalemax, scalemax2)) {

            // Add the Y Axis
            y0.domain([0, Math.max(scalemax, scalemax2)]);

            setOneYAxis(svg, "y axis left");


            addLine(svg, data, "1", selectedSpecies, selectedCompartment, valueline1);

            addLine(svg, data, "2", selectedSpecies2, selectedCompartment2, valueline1);

        } else {


// Else Statement when the ranges are different--------------------------------------------------

            // Add the Y Axis
            y0.domain([0, d3.max(data.filter(function (d) {
                return d.species === selectedSpecies && d.compartment === selectedCompartment
            }), function (d) {
                return d.concentration
            })]);


            y1.domain([0, d3.max(data.filter(function (d) {
                return d.species === selectedSpecies2 && d.compartment === selectedCompartment2
            }), function (d) {
                return d.concentration
            })]);

            setOneYAxis(svg,  "y axis left", "1");
            setOneYAxis(svg,  "y axis right", "2");






            addLine(svg, data, "1", selectedSpecies, selectedCompartment, valueline1);
            addLine(svg, data, "2", selectedSpecies2, selectedCompartment2, valueline2);


        }


    });


    //Functions


    //Function onChange ____________________________________________________________________________________________________
    function onchange() {
        // Add the valueline path.

        d3.csv("node_(0, 0)_concentrations.csv", function (error, data) {
            data.forEach(function (d) {
                d.species = d.species
                d.elapsed_time = +d.elapsed_time;
                d.concentration = +d.concentration;
                d.compartment = d.compartment;
            });


            selectedCompartment = $("#btn-d1_1").text();
            selectedSpecies = $("#btn-d1_2").text();

            selectedCompartment2 = $("#btn-d2_1").text();
            selectedSpecies2 = $("#btn-d2_2").text();


            // Select the section we want to apply our changes to


            x.domain(d3.extent(data, function (d) {
                return d.elapsed_time;
            }));

            var scalemax = getTheRange(nested_data, selectedSpecies, selectedCompartment, selectedSpecies2, selectedCompartment2)[0];
            var scalemax2 = getTheRange(nested_data, selectedSpecies, selectedCompartment, selectedSpecies2, selectedCompartment2)[1];

            console.log(scalemax);
            if (compareRange(scalemax, scalemax2)) {

                y0.domain([0, Math.max(scalemax, scalemax2)]);
                y1.domain([0, 0]);

                // Make the changes

                changeline("1", selectedSpecies, selectedCompartment, valueline1, data);
                changeline("2", selectedSpecies2, selectedCompartment2, valueline1, data);
                changeaxis("1", "y axis left");
                changeaxis("2", "y axis right");


            } else {


                y0.domain([0, d3.max(data.filter(function (d) {
                    return d.species === selectedSpecies && d.compartment === selectedCompartment
                }), function (d) {
                    return d.concentration
                })]);


                y1.domain([0, d3.max(data.filter(function (d) {
                    return d.species === selectedSpecies2 && d.compartment === selectedCompartment2
                }), function (d) {
                    return d.concentration
                })]);


                changeline("1", selectedSpecies, selectedCompartment, valueline1, data);
                changeline("2", selectedSpecies2, selectedCompartment2, valueline2, data);
                changeaxis("1", "y axis left");
                changeaxis("2", "y axis right");


            }

        });


    }


    //Get the maximum value of a dataset____________________________________________________________________________________
    function getTheRange(nested_data, spec1, comp1, spec2, comp2) {

        var scalemax = 0;

        for (var zzz = 0; zzz < nested_data.length; zzz++) {
            if (nested_data[zzz].key === spec1) {
                for (var xxx = 0; xxx < nested_data[zzz].values.length; xxx++) {
                    if (nested_data[zzz].values[xxx].key === comp1) {
                        scalemax = nested_data[zzz].values[xxx].value.scalemax;

                    }
                }


            }
        }

        var scalemax2 = 0;

        for (var zzz = 0; zzz < nested_data.length; zzz++) {
            if (nested_data[zzz].key === spec2) {
                for (var xxx = 0; xxx < nested_data[zzz].values.length; xxx++) {
                    if (nested_data[zzz].values[xxx].key === comp2) {
                        scalemax2 = nested_data[zzz].values[xxx].value.scalemax;

                    }
                }


            }
        }
        return [scalemax, scalemax2];
    }

    //Add choicebox for compartment_________________________________________________________________________________________
    function addChoiceBox(selection, id, category) {
        //Dropdown Box 1 Compartment


        var dropOneComp = d3.select(".container.Boxes")
            .append("div").attr("class", "selection" + id).style("position", "relative").style("float", "left") //position: relative; margin-right: 240px
            .append("div").attr("id", "Tablediv" + id).attr("class", "dropdown")
            .append("button").attr("id", "btn-d" + id).attr("class", "btn btn-outline-" + id ).attr("type", "button").attr("data-toggle", "dropdown").text(category)
            .append("span").attr("class", "caret");
        var UlHelp = d3.select("#Tablediv" + id).append("ul").attr("id", "TableMenu" + id).attr("class", "dropdown-menu");
        for (var i = 0; i < selection.length; i++) {
            UlHelp.append("li").append("a").attr("href", "#").text(selection[i].key).on("click", function () {
                onchange()
            });
        }
        getTextFromBoxes("#TableMenu" + id, "#btn-d" + id);

    }


    function getTextFromBoxes(tabMenu, ButtonName) {


        $(tabMenu + " a").click(function (e) {
            e.preventDefault();
            var selText = $(this).text();
            $(ButtonName).text(selText);
            console.log(selText);

            return selText;


        })

    }

    //Set the Axis__________________________________________________________________________________________________________
    function setXAxis(svg) {

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));


    }

    function setOneYAxis(svg, name, id) {

if(name === "y axis right") {
    svg.append("g")
        .attr("class", name)
        .attr("transform", "translate(" + width + " ,0)")
        .styles({fill: "none", stroke: $(".btn-outline-" + id + "_1").css("color"), "stroke-width": "0.5"})
        .call(d3.axisRight(y0));
}else {

    svg.append("g")
        .attr("class", name)
        .styles({fill: "none", stroke: $(".btn-outline-" + id + "_1").css("color"), "stroke-width": "0.5"})
        .call(d3.axisLeft(y1));
}
    }

    function compareRange(scalemax, scalemax2) {


        if (Math.abs(Math.log10(Math.max(scalemax, scalemax2)) - Math.log10(Math.min(scalemax, scalemax2))) < 0.7) {
            return true;
        }
    }


    function responsivefy(svg) {
        // get container + svg aspect ratio
        var container = d3.select(svg.node().parentNode),
            width = parseInt(svg.style("width")),
            height = parseInt(svg.style("height")),
            aspect = width / height;

        // add viewBox and preserveAspectRatio properties,
        // and call resize so that svg resizes on inital page load
        svg.attr("viewBox", "0 0 " + width + " " + height)
            .attr("preserveAspectRatio", "xMinYMid")
            .call(resize);

        // to register multiple listeners for same event type,
        // you need to add namespace, i.e., 'click.foo'
        // necessary if you call invoke this function for multiple svgs
        // api docs: https://github.com/mbostock/d3/wiki/Selections#on
        d3.select(window).on("resize." + container.attr("id"), resize);

        // get width of container and resize svg to fit it
        function resize() {
            var targetWidth = parseInt(container.style("width"));
            svg.attr("width", targetWidth);
            svg.attr("height", Math.round(targetWidth / aspect));
        }
    }


    function addLine(svg, data, id, spec, comp, val) {
        svg.append("path")
            .data([data])
            .attr("id", "line" + id)
            .style("stroke", $(".btn-outline-" + id + "_1").css("color"))
            .attr("d", val(data.filter(function (d) {
                return d.species === spec && d.compartment === comp
            })));

    }

    function changeline(id, spec, comp, val, data) {


        var svg = d3.select("body").transition();
        svg.select("#line" + id)   // change the line
            .duration(750)
            .attr("d", val(data.filter(function (d) {
                return d.species === spec && d.compartment === comp
            })));


    }

    function changeaxis(id, name) {

        var svg = d3.select("body").transition();

if (name === "y axis left") {
    svg.select(".y.axis.left") // change the y axis
        .duration(750)
        .styles({fill: "none", stroke: $(".btn-outline-" + id + "_1").css("color"), "stroke-width": "0.5"})
        .call(d3.axisLeft(y0));
}else {


    svg.select(".y.axis.right") // change the y axis
        .duration(750)
        .styles({fill: "none", stroke: $(".btn-outline-" + id + "_1").css("color"), "stroke-width": "0.5"})
        .call(d3.axisRight(y1));

}



    }





</script>
</body>
</html>



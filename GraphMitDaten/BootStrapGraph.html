<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style> /* set the CSS */

    body {
        font: 12px Arial;
        text-align: center;
    }

    path {

        stroke-width: 2;
        fill: none;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }

    .overlay {
        fill: none;
        pointer-events: all;
    }

    .focus circle {
        fill: none;
        stroke: steelblue;
    }

    #Boxes {
        margin: auto;
        width: 20%;
        padding: 10px;

    }

    svg {
        margin: auto;
        padding: 10px;

    }


    </style>


    <script src="https://d3js.org/d3.v3.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
            integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">


</head>
<body>

<div id="main">


</div>

<div id="svg">


</div>

<div id="Boxes">

</div>


<script>


    //Settings of the graph

    // Set the dimensions of the canvas / graph
    var margin = {top: 30, right: 50, bottom: 30, left: 50},
        width = 700 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;


    // Set the ranges
    var x = d3.scale.linear().range([0, width]);
    var y0 = d3.scale.linear().range([height, 0]);
    var y1 = d3.scale.linear().range([height, 0]);

    // Define the axes
    var xAxis = d3.svg.axis().scale(x)
        .orient("bottom").ticks(5);

    var yAxisLeft = d3.svg.axis().scale(y0)
        .orient("left").ticks(5);

    var yAxisRight = d3.svg.axis().scale(y1)
        .orient("right").ticks(5);


    // Define the lines
    var valueline = d3.svg.line()
        .x(function (d) {
            return x(d.elapsed_time);
        })
        .y(function (d) {
            return y0(d.concentration);
        });


    var valueline2 = d3.svg.line()
        .x(function (d) {
            return x(d.elapsed_time);
        })
        .y(function (d) {
            return y1(d.concentration);
        });

    // Adds the svg canvas
    var svg = d3.select("#svg")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        .style("float", "left");

    //Label X-Axis
    svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "end")
        .attr("x", width)
        .attr("y", height + 20)
        .text("Elapsed time [ms]");

    //Label Y-Axis
    svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "end")
        .attr("y", -50)
        .attr("x", -70)
        .attr("dy", ".75em")
        .attr("transform", "rotate(-90)")
        .text("Concentration [nmol/l]");


    // _________________Get the data_____________________________________________________
    d3.csv("node_(0, 0)_concentrations.csv", function (error, data) {
        data.forEach(function (d) {
            d.species = d.species
            d.elapsed_time = +d.elapsed_time;
            d.concentration = +d.concentration;
            d.compartment = d.compartment;

        });


        // Nest the Data________________________________________________________________________________________________

        nested_data = d3.nest()
            .key(function (d) {
                return d.species;
            })
            .key(function (d) {
                return d.compartment;
            })
            .rollup(function (d) {
                d.scalemin = d3.min(d, function (d) {
                    return d.concentration
                });

                d.scalemax = d3.max(d, function (d) {
                    return d.concentration;
                });
                return d;
            })

            .entries(data);

        console.log(nested_data[11].values[0].values.scalemax);


        //-----------Key the data for drop down---------------------------------------------------------------------------

        var compartmentSelection = d3.nest()
            .key(function (d) {
                return d.compartment;
            })
            .rollup(function (v) {
                return v.length;
            })
            .entries(data);


        var speciesSelection = d3.nest()
            .key(function (d) {
                return d.species;
            })
            .rollup(function (v) {
                return v.length;
            })
            .entries(data);


        //---------------------------------------------------------------------------------------------------------------

        // Add Coiceboxes-------------------------------------------------------------------------------------------------


        selectedCompartment = addChoiceBoxComp(compartmentSelection, "CompartmentList", "warning");

        selectedSpecies = addChoiceboxSpec(speciesSelection, "SpeciesList", "warning");


        // The Second Box-----------------------------------------------------------------


        selectedCompartment2 = addChoiceBoxComp(compartmentSelection, "CompartmentList2", "success");

        selectedSpecies2 = addChoiceboxSpec(speciesSelection, "SpeciesList2", "success");

        //The maximum of the Dataset------------------------------------------------------------

        var scalemax = getTheRange(nested_data, selectedSpecies, selectedCompartment, selectedSpecies2, selectedCompartment2)[0];
        var scalemax2 = getTheRange(nested_data, selectedSpecies, selectedCompartment, selectedSpecies2, selectedCompartment2)[1];


        // Add the X Axis
        x.domain(d3.extent(data, function (d) {
            return d.elapsed_time;
        }));

        setXAxis(svg, xAxis);

        // Define the Y Axis and the valuelines. If statement for matching datarange-------------------------------------
        if (Math.abs(Math.log10(Math.max(scalemax, scalemax2))) - Math.abs(Math.log10(Math.min(scalemax, scalemax2))) < 0.7) {

            // Add the Y Axis
            y0.domain([0, Math.max(scalemax, scalemax2)]);

            setOneYAxis(svg, yAxisLeft, "y axis left");


            // Add the lines
            svg.append("path")
                .data([data])
                .attr("id", "line")
                .style("stroke", "#d95f02")
                .attr("d", valueline(data.filter(function (d) {
                    return d.species == selectedSpecies && d.compartment == selectedCompartment

                })));


            svg.append("path")
                .data([data])
                .attr("id", "line2")
                .style("stroke", "#66a61e")
                .attr("d", valueline2(data.filter(function (d) {
                    return d.species == selectedSpecies2 && d.compartment == selectedCompartment2

                })));

        } else {


// Else Statement when the ranges are different--------------------------------------------------

            // Add the Y Axis
            y0.domain([0, d3.max(data.filter(function (d) {
                return d.species === selectedSpecies && d.compartment === selectedCompartment
            }), function (d) {
                return d.concentration
            })]);


            y1.domain([0, d3.max(data.filter(function (d) {
                return d.species === selectedSpecies2 && d.compartment === selectedCompartment2
            }), function (d) {
                return d.concentration
            })]);

            setOneYAxis(svg, yAxisLeft, "y axis left", "#d95f02");
            setOneYAxis(svg, yAxisRight, "y axis right", "#66a61e");


            //Add the lines---------------------------------------------------------
            svg.append("path")
                .data([data])
                .attr("id", "line")
                .style("stroke", "#d95f02")
                .attr("d", valueline(data.filter(function (d) {
                    return d.species == selectedSpecies && d.compartment == selectedCompartment

                })));


            svg.append("path")
                .data([data])
                .attr("id", "line2")
                .style("stroke", "#66a61e")
                .attr("d", valueline2(data.filter(function (d) {
                    return d.species == selectedSpecies2 && d.compartment == selectedCompartment2

                })));


        }


    });


    //Functions


    //Get the maximum value of a dataset____________________________________________________________________________________
    function getTheRange(nested_data, spec1, comp1, spec2, comp2) {

        var scalemax = 0;

        for (var zzz = 0; zzz < nested_data.length; zzz++) {
            if (nested_data[zzz].key === spec1) {
                for (var xxx = 0; xxx < nested_data[zzz].values.length; xxx++) {
                    if (nested_data[zzz].values[xxx].key === comp1) {
                        scalemax = nested_data[zzz].values[xxx].values.scalemax;

                    }
                }


            }
        }

        var scalemax2 = 0;

        for (var zzz = 0; zzz < nested_data.length; zzz++) {
            if (nested_data[zzz].key === spec2) {
                for (var xxx = 0; xxx < nested_data[zzz].values.length; xxx++) {
                    if (nested_data[zzz].values[xxx].key === comp2) {
                        scalemax2 = nested_data[zzz].values[xxx].values.scalemax;

                    }
                }


            }
        }
        return [scalemax, scalemax2];
    }

    //Add choicebox for compartment_________________________________________________________________________________________
    function addChoiceBoxComp(compartmentSelection, name, bootCl) {
        //Dropdown Box 1 Compartment


        var dropOneComp = d3.select("#Boxes")
            .append("div").attr("class", name).style("position", "relative").style("float", "left") //position: relative; margin-right: 240px
            .append("div").attr("class", "dropdown")
            .append("button").attr("class", "btn btn-outline-" + bootCl + " dropdown-toggle").attr("type", "button").attr("data-toggle", "dropdown").text("Compartment")
            .append("span").attr("class", "caret")
            .append("ul").attr("class", "dropdown-menu");
        for (var i = 0; i < compartmentSelection.length; i++) {
            dropOneComp.append("li").append("a").attr("href", "#").text(compartmentSelection[i].key);
        }


        console.log($(this).find("option:selected").text())


    }

    //Set the choiceboxes for species___________________________________________________________________________________________________
    function addChoiceboxSpec(speciesSelection, name, bootCl) {
        //Dropdown box 2 (Species)

        var dropOneSpe = d3.select("#Boxes")
            .append("div").attr("class", name).style("position", "relative").style("float", "left")
            .append("div").attr("class", "dropdown").style("position", "relative")
            .append("button").attr("class", "btn btn-outline-" + bootCl + " dropdown-toggle").attr("type", "button").attr("data-toggle", "dropdown").text("Species")
            .append("span").attr("class", "caret")
            .append("ul").attr("class", "dropdown-menu");
        for (var i = 0; i < speciesSelection.length; i++) {
            dropOneSpe.append("li").append("a").attr("href", "#").text(speciesSelection[i].key);
        }


        return $().find("option:selected").text()

    }

    //Set the Axis__________________________________________________________________________________________________________
    function setXAxis(svg, XA) {

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(XA);


    }

    function setOneYAxis(svg, call, name, fill) {
        svg.append("g")
            .attr("class", name)
            .style("fill", fill)
            .call(call);
    }

    //Function onChange ____________________________________________________________________________________________________
    function onchange() {
        // Add the valueline path.

        d3.csv("node_(0, 0)_concentrations.csv", function (error, data) {
            data.forEach(function (d) {
                d.species = d.species
                d.elapsed_time = +d.elapsed_time;
                d.concentration = +d.concentration;
                d.compartment = d.compartment;
            });


            selectedCompartment = d3.select("#CompartmentList").property("value");

            selectedSpecies = d3.select("#SpeciesList").property("value");

            selectedCompartment2 = d3.select("#CompartmentList2").property("value");

            selectedSpecies2 = d3.select("#SpeciesList2").property("value");


            // Select the section we want to apply our changes to
            var svg = d3.select("body").transition();

            x.domain(d3.extent(data, function (d) {
                return d.elapsed_time;
            }));

            var scalemax = getTheRange(nested_data, selectedSpecies, selectedCompartment, selectedSpecies2, selectedCompartment2)[0];
            var scalemax2 = getTheRange(nested_data, selectedSpecies, selectedCompartment, selectedSpecies2, selectedCompartment2)[1];


            if (Math.abs(Math.log10(Math.max(scalemax, scalemax2))) - Math.abs(Math.log10(Math.min(scalemax, scalemax2))) < 0.7) {

                y0.domain([0, Math.max(scalemax, scalemax2)]);
                y1.domain([0, 0]);

                // Make the changes
                svg.select("#line")   // change the line
                    .duration(750)
                    .attr("d", valueline(data.filter(function (d) {
                        return d.species === selectedSpecies && d.compartment === selectedCompartment
                    })));

                svg.select("#line2")   // change the line
                    .duration(750)
                    .attr("d", valueline(data.filter(function (d) {
                        return d.species === selectedSpecies2 && d.compartment === selectedCompartment2
                    })));


                svg.select(".y.axis.left") // change the y axis
                    .duration(750)
                    .call(yAxisLeft);


                svg.select(".y.axis.right") // change the y axis
                    .duration(750)
                    .call(yAxisRight);


            } else {

                y0.domain([0, d3.max(data.filter(function (d) {
                    return d.species == selectedSpecies && d.compartment == selectedCompartment

                }), function (d) {
                    return d.concentration
                })]);


                // Make the changes
                svg.select("#line")   // change the line
                    .duration(750)
                    .attr("d", valueline(data.filter(function (d) {
                        return d.species == selectedSpecies && d.compartment == selectedCompartment
                    })));


                svg.select(".y.axis.left") // change the y axis
                    .duration(750)
                    .call(yAxisLeft);


                y1.domain([0, d3.max(data.filter(function (d) {
                    return d.species === selectedSpecies2 && d.compartment === selectedCompartment2

                }), function (d) {
                    return d.concentration
                })]);

                svg.select("#line2")   // change the line
                    .duration(750)
                    .attr("d", valueline2(data.filter(function (d) {
                        return d.species === selectedSpecies2 && d.compartment === selectedCompartment2
                    })));

                svg.select(".y.axis.right") // change the y axis
                    .duration(750)
                    .call(yAxisRight);


            }

        });


    }

</script>
</body>
</html>



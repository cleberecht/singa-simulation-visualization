<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style> /* set the CSS */

    body {
        font: 12px Arial;
    }

    path {

        stroke-width: 2;
        fill: none;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }

    .overlay {
        fill: none;
        pointer-events: all;
    }

    div {

        color: #445588;
        margin-right: auto;
        padding: auto;
        width: 300px;
        height: 150px;
        background-color: aquamarine;
    }

    .focus circle {
        fill: none;
        stroke: steelblue;
    }

    </style>

    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>


</head>
<body>


<script>

    let time=[];
    let compartments=[];
    let species=[];

    // Get the data
    d3.csv("node_(0, 0)_concentrations.csv", function (error, data) {
        data.forEach(function (d) {
            d.species = d.species
            d.elapsed_time = +d["elapsed time"];
            d.concentration = +d.concentration;
            d.compartment = d.compartment;


            if (!time.includes(d.elapsed_time)) {
                time.push(d.elapsed_time)
            }


            if (!compartments.includes(d.compartment)) {
                compartments.push(d.compartment)
            }


            if (!species.includes(d.species)) {
                species.push(d.species)
            }

        });

        nestedData =

            d3.nest()
                .key(function (d) {
                    return d.elapsed_time;
                })
                .key(function (d) {
                    return d.compartment;
                })
                .key(function (d) {
                    return d.species;
                })
                .rollup(function (v) {
                    return d3.sum(v, function (d) {
                        return d.concentration;
                    });
                })
                .map(data);


        console.log(nestedData);


        let rememberSpecies= [];

        compartments.forEach(function (comp) {
            nestedData.keys().forEach(function (element) {

                nestedData.get(element).get(comp).keys().forEach(function (species) {

                    if (!rememberSpecies.includes(species) && nestedData.get(element).get(comp).get(species) > 0) {

                        rememberSpecies.push(species);

                        var id = "k" + i.toString();


                        var div = d3.select("body")
                            .append("div")
                            .attr("class", id);



                        createchart(species, comp, width, height, id);


                    }
                }
                )}
            )})


        var i;
        for (i = 0; i < nested_data.length; i++) {
            for (var j = 0; j < 2; j++) {
                if (nested_data[i].values[j].values.scalemax > 0) {
                    console.log(nested_data[i].key);
                    var hlp1 = nested_data [i].key;
                    var hlp2 = nested_data[i].values[j].values[0].compartment;
                    var id = "k" + i.toString();


                    var div = d3.select("body")
                        .append("div")
                        .attr("class", id);



                    createchart(hlp1, hlp2, data, width, height, id);


                }
            }
        }


    });


    //-------------------------------------------------------------------------------------------------------------------------
    function createchart(spec, comp, w, h, id) {

        // Set the dimensions of the canvas / graph
let data = filterData(spec, comp);

        var margin = {top: 30, right: 50, bottom: 35, left: 50},
            width = w - margin.left - margin.right,
            height = h - margin.top - margin.bottom;


        // Set the ranges
        var x = d3.scale.linear().range([0, width]);
        var y0 = d3.scale.linear().range([height, 0]);


        // Define the axes
        var xAxis = d3.svg.axis().scale(x)
            .orient("bottom").ticks(5);

        var yAxisLeft = d3.svg.axis().scale(y0)
            .orient("left").ticks(5);


        // Define the line
        var valueline = d3.line();



        // Adds the svgMain canvas
        var svg = d3.select("." + id)
            .append("svgMain")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left}, ${margin.top})`);


        //Label X-Axis
        svg.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "end")
            .attr("x", width)
            .attr("y", height + 30)
            .text("Elapsed time [ms]");

        //Label Y-Axis
        svg.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "end")
            .attr("y", -45)
            .attr("x", -0)
            .attr("dy", ".50em")
            .attr("transform", "rotate(-90)")
            .text("Concentration [nmol/l]");

        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .style("font-size", "10px")
            .style("text-decoration", "underline")
            .text(spec + " - " + comp);




        // Die Länge der X und Y Achsen bestimmten (Bei Y über das Maximum der gefilterten Daten
        // Bei den Select Items mit beachten
        x.domain(d3.extent(ttt, function (d) {
            return d.elapsed_time;
        }));

        y0.domain([0, d3.max(ttt.filter(function (d) {
            return spec === d.species && comp === d.compartment
        }), function (d) {
            return d.concentration
        })]);


        // Add the X Axis
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        // Add the Y Axis
        svg.append("g")
            .attr("class", "y axis left")
            .style("fill", "#d95f02")
            .call(yAxisLeft);


        svg.append("path")
            .datum(data)
            .attr("id", "line_first")
            .style("stroke", "red") //$(".btn-outline-" + id + "_1").css("color")
            .attr("d", valueline
                .x(function (d) {

                    return x(d.x);
                })
                .y(function (d) {
                    return y0(d.y);
                }));




    }

    function filterData(compartment, species) {

        let trajektoryData = [];

        let obj = {};


        nestedData.keys().forEach(function (element) {

            if (nestedData.get(element).get(compartment).get(species) === undefined) {

                obj = {
                    x: parseFloat(element),
                    y: 0
                };

                trajektoryData.push(obj);


            } else {
                obj = {
                    x: parseFloat(element),
                    y: nestedData.get(element).get(compartment).get(species)
                };

                trajektoryData.push(obj);

            }
        });
        // console.log(trajektoryData);

        console.log(trajektoryData);
        return trajektoryData;


    }





    /*
        function onchange() {
            // Add the valueline path.

            d3.csv("node_(0, 0)_concentrations.csv", function (error, data) {
                data.forEach(function (d) {
                    d.species = d.species
                    d.elapsed_time = +d.elapsed_time;
                    d.concentration = +d.concentration;
                    d.compartment = d.compartment;
                });


                selectedCompartment = d3.select("#CompartmentList").property("value");

                selectedSpecies = d3.select("#SpeciesList").property("value");

                // Select the section we want to apply our changes to
                var svgMain = d3.select("body").transition();

                x.domain(d3.extent(data, function (d) {
                    return d.elapsed_time;
                }));

                y0.domain([0, d3.max(data.filter(function (d) {
                    return d.species == selectedSpecies && d.compartment == selectedCompartment

                }), function (d) {
                    return d.concentration
                })]);


                // Make the changes
                svgMain.select("#line")   // change the line
                    .duration(750)
                    .attr("d", valueline(data.filter(function (d) {
                        return d.species == selectedSpecies && d.compartment == selectedCompartment
                    })));


                svgMain.select(".y.axis.left") // change the y axis
                    .duration(750)
                    .call(yAxisLeft);




    //Second Graph-------------------------------------------------------------------------

                selectedCompartment2 = d3.select("#CompartmentList2").property("value");

                selectedSpecies2 = d3.select("#SpeciesList2").property("value");

                y1.domain([0, d3.max(data.filter(function (d) {
                    return d.species == selectedSpecies2 && d.compartment == selectedCompartment2

                }), function (d) {
                    return d.concentration
                })]);

                svgMain.select("#line2")   // change the line
                    .duration(750)
                    .attr("d", valueline2(data.filter(function (d) {
                        return d.species == selectedSpecies2 && d.compartment == selectedCompartment2
                    })));

                svgMain.select(".y.axis.right") // change the y axis
                    .duration(750)
                    .call(yAxisRight);


            });


        }
        */


</script>
</body>
</html>


